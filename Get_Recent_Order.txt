CREATE PROCEDURE [dbo].[Get_Recent_Order]
	@User NVARCHAR(128),
	@CustomerId NVARCHAR(128)
AS

IF EXISTS(SELECT 1 FROM CUSTOMERS WHERE Email = @User AND CUSTOMERID = @CustomerId)
BEGIN 

-- return that the customer is valid
	SELECT 1 AS IsValidCustomer;
	
-- This section will return the order details

	WITH CTE AS
	(
	SELECT TOP 1 C.FIRSTNAME,C.LASTNAME, 
		O.ORDERID,O.ORDERDATE,
		O.DELIVERYEXPECTED, O.CONTAINSGIFT,
		CONCAT(HOUSENO,' ', STREET,' ', TOWN,' ',POSTCODE) AS DELIVERYADDRESS
	FROM  ORDERS O INNER JOIN CUSTOMERS C ON O.CUSTOMERID = C.CUSTOMERID
	WHERE C.Email = @User AND C.CUSTOMERID = @CustomerId 
	ORDER BY ORDERDATE DESC 
	)
	SELECT T.*,P.PRODUCTNAME,OI.QUANTITY,OI.PRICE FROM CTE T INNER JOIN  ORDERITEMS OI ON OI.ORDERID =T.ORDERID
	INNER JOIN PRODUCTS P ON P.PRODUCTID = OI.PRODUCTID

--This will return only customer details for showing valid customer with no order 
	SELECT C.FIRSTNAME,C.LASTNAME FROM CUSTOMERS C WHERE C.Email = @User AND C.CUSTOMERID = @CustomerId
END 
ELSE 
BEGIN 
	SELECT 0 AS IsValidCustomer;
END

GO
